import axiosInstance from "./axiosInstance";

// âœ… 1. ê³ ì •ëœ í”„ë¡œì íŠ¸ ì„¤ëª… ë° ìš”ì²­ ë°©ì‹
const PROJECT_DESCRIPTION = `
ë‹¹ì‹ ì€ ë©´ì ‘ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì§€ì›ìì˜ ì‹¤ì œ ìì†Œì„œë¥¼ ê·¼ê±°ë¡œ ì‹¤ì œ ë©´ì ‘ ì§ˆë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
ìì†Œì„œ1~Nì„ ì½ì–´ì£¼ì„¸ìš”.


ì¤‘ìš”í•œ ìš”ì²­:
1. ê° ì§ˆë¬¸ì€ ë°˜ë“œì‹œ "ìê¸°ì†Œê°œì„œ"ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼í•©ë‹ˆë‹¤.
2. ê° ì§ˆë¬¸ì„ ë§Œë“¤ ë•, ìê¸°ì†Œê°œì„œë¥¼ ì°¸ê³ í•˜ë˜, ìê¸°ì†Œê°œì„œ ì•ˆì— ë‹¹ì‹ ì´ ë§Œë“  ì§ˆë¬¸ì— ëŒ€í•œ ë‹µì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹¨ìˆœí•œ ë‚œì´ë„ì˜ ì§ˆë¬¸ì„ ë§Œë“¤ì–´ì„  ì•ˆ ë©ë‹ˆë‹¤.
3. ê° ì§ˆë¬¸ì„ ë§Œë“¤ ë•, ìê¸°ì†Œê°œì„œì˜ ê·¼ê±°ê°€ë˜ëŠ” ë¶€ë¶„ì„ ê³ ë„í™”í•˜ì—¬ ì§ˆë¬¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
4. ê° ì§ˆë¬¸ì„ ë§Œë“¤ ë•, í•´ë‹¹ ì§ˆë¬¸ì˜ 'ê·¼ê±°'ê°€ë˜ëŠ” ë¶€ë¶„ì„ ìì†Œì„œ ë‚´ì—ì„œ ì°¾ì•„ì•¼í•©ë‹ˆë‹¤.
5. ê° ì§ˆë¬¸ì˜ ê·¼ê±°ë¥¼ ì°¾ì„ ë•, ì¼ë°˜ì ìœ¼ë¡œ 'ì˜¨ì „í•œ ë¬¸ì¥'ì„ ì°¾ì•„ì•¼í•©ë‹ˆë‹¤. ì¦‰, ì£¼ì–´ë¡œ ì‹œì‘í•˜ì—¬ ëë§ºìŒ ë¬¸ì¥ìœ¼ë¡œ ëë‚˜ëŠ” ë¶€ë¶„ì„ ì°¾ì•„ì•¼í•©ë‹ˆë‹¤.
6. ê° ì§ˆë¬¸ì˜ ê·¼ê±°ë¥¼ ì°¾ì„ ë•Œ ì˜¨ì „í•œ ë¬¸ì¥ì´ 100ìë¥¼ ë„˜ì–´ê°€ê²Œ ë  ê²½ìš°, ê·¸ ë‚´ì—ì„œ ìµœëŒ€í•œ ì§§ê²Œ ì˜¨ì „í•œë¬¸ì¥ì„ ì´ë£¨ëŠ” ë¶€ë¶„ì„ ì°¾ì•„ì•¼í•©ë‹ˆë‹¤.
7. ê° ì§ˆë¬¸ì„ ë§Œë“¤ ë• ë‹¨ìˆœ ë°˜ë³µ ì§ˆë¬¸ì€ í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
8. ê° ì§ˆë¬¸ì˜ ê·¼ê±°ëŠ” 'í•œ ê°œì˜ ë¬¸ì¥'ì´ì–´ì•¼í•©ë‹ˆë‹¤. ë‘ ê°œì˜ ë¬¸ì¥ì€ ë˜ë„ë¡ ì°¾ì§€ ë§ì•„ì£¼ì„¸ìš”.
9. ê° ì§ˆë¬¸ì˜ ê·¼ê±°ë¥¼ ì°¾ì„ ë•Œ start indexì™€ end indexê°€ ë°˜ë“œì‹œ ë¬¸ì¥ ê¸¸ì´ë³´ë‹¤ ì§§ê±°ë‚˜ ê¸¸ë©´ ì•ˆ ë©ë‹ˆë‹¤. ë˜í•œ, ì¶”í›„ ì²˜ë¦¬ë¥¼ ì—¼ë‘í•´ ì• ë’¤ ì•½ 10ê°œ ì¸ë±ìŠ¤ì •ë„ë¥¼ í™•ë³´í•œ ì´í›„ë¡œ ì°¾ì•„ì£¼ì„¸ìš”.
10. ìê¸°ì†Œê°œì„œì™€ ë¬´ê´€í•œ ì§ˆë¬¸ì„ ë§Œë“¤ì§€ ë§ˆì„¸ìš”.
11. ê·¼ê±°ëŠ” ë¬´ì¡°ê±´ ì°¾ì•„ì•¼í•©ë‹ˆë‹¤.
12. ê° ì§ˆë¬¸ì˜ ë‚œì´ë„ëŠ” ìµœì†Œ ì‰¬ì›€, ë³´í†µ, ì–´ë ¤ì›€ 3ë‹¨ê³„ ì¤‘ ê°ê° í•œ ê°œì”© í•„ìš”í•©ë‹ˆë‹¤.
13. ì§€ì›ìì˜ ì§ë¬´ë¥¼ ë‹¹ì‹ ì´ íŒŒì•…í•˜ì—¬ ì§ë¬´ ê´€ë ¨ ì§ˆë¬¸, HRì¼ë°˜ ê´€ë ¨ ì§ˆë¬¸ì´ ê³¨ê³ ë£¨ ë¶„ë°°ë˜ë„ë¡ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
14. ì§ˆë¬¸ìê°€ ë‹µë³€í–ˆì„ ë•Œ ê¼¬ë¦¬ì§ˆë¬¸ì´ ê°€ëŠ¥í•˜ë„ë¡ ì§ˆë¬¸ì„ ìœ ë„í•´ì£¼ì„¸ìš”.
  
ê°ê°ì˜ ì§ˆë¬¸ì€ ìê¸°ì†Œê°œì„œ ë‚´ìš©ê³¼ ì¼ì¹˜í•´ì•¼ í•˜ë©°, ì¶œì²˜ë¥¼ ë°˜í™˜í•  ë•Œì—ëŠ” ì›ë³¸ ìì†Œì„œì—ì„œ í•´ë‹¹ ë¬¸ì¥ì„ ì°¾ì•„ ì¸ë±ìŠ¤ë¡œ ë°˜í™˜í•˜ì„¸ìš”. 

`;

// âœ… 3. ê³ ì •ëœ ì‘ë‹µ í˜•ì‹ (ìˆ˜ì •ë¨)
const RESPONSE_FORMAT = `
ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒê³¼ ê°™ì€ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:
{
  "key_number": "ì§€ì›ì ì‹ë³„ë²ˆí˜¸",
  "cover_letter_num": ì§ˆë¬¸ì„ ë§Œë“¤ ìì†Œì„œ ê°œìˆ˜,
  "question_num": ê° ìì†Œì„œë³„ ë§Œë“¤ ì§ˆë¬¸ ê°œìˆ˜ , // ë°°ì—´ ì•„ë‹˜. ì •ìˆ˜ê°’ í•˜ë‚˜ì„
  "question1-1": "1ë²ˆ ìì†Œì„œì— ëŒ€í•œ ì§ˆë¬¸ 1",
  "question1-2": "1ë²ˆ ìì†Œì„œì— ëŒ€í•œ ì§ˆë¬¸ 2",
  "clue1-1": { "start_index": 55, "end_index": 120 }, // 1ë²ˆ ì§ˆë¬¸ì˜ ê·¼ê±° ì¶œì²˜ ì¸ë±ìŠ¤
  "clue1-2": { "start_index": 140, "end_index": 180 }, // 2ë²ˆ ì§ˆë¬¸ì˜ ê·¼ê±° ì¶œì²˜ ì¸ë±ìŠ¤
  "questionN-M": "Në²ˆ ìì†Œì„œì— ëŒ€í•œ ì§ˆë¬¸ M",
  "clueN-M": { "start_index": XXX, "end_index": YYY } // Në²ˆ ìì†Œì„œ Më²ˆ ì§ˆë¬¸ì˜ ê·¼ê±° ì¶œì²˜ ì¸ë±ìŠ¤
}
JSON ì´ì™¸ì˜ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì§€ ë§ˆì„¸ìš”.
`;

// âœ… GPT API ìš”ì²­ í•¨ìˆ˜
export const sendPrompt = async (userData, userRequest, secretPassword) => {
    if (!userData || !userData.key_number) {
        throw new Error("âŒ ìœ íš¨í•œ ì§€ì›ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. key_numberê°€ í•„ìš”í•©ë‹ˆë‹¤.");
    }

    // âœ… 2. ì‚¬ìš©ì ì‹¤ì œ ë°ì´í„° (ê°œë³„ ì§€ì›ì)
    const userDataString = JSON.stringify(userData, null, 2);

    // âœ… 4. ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ì¶”ê°€ ìš”ì²­ ì‚¬í•­
    const userRequestString = userRequest.trim() ? `\nì¶”ê°€ ìš”ì²­ ì‚¬í•­: ${userRequest}` : "";

    // âœ… ìµœì¢… í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    const finalPrompt = `
${PROJECT_DESCRIPTION}

[ì‚¬ìš©ì ë°ì´í„°]
${userDataString}

[ì‘ë‹µ í˜•ì‹]
${RESPONSE_FORMAT}
${userRequestString}
`;

    console.log("ğŸ”¹ ìµœì¢… GPT ìš”ì²­ í”„ë¡¬í”„íŠ¸:", finalPrompt);

    try {
        // âœ… API ìš”ì²­ (í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¶ˆëŸ¬ì˜¨ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
        const response = await axiosInstance.post("/gpt/generate-text", {
            prompt: finalPrompt,
            max_tokens: 3000,  // âœ… í† í° ìˆ˜ ì¦ê°€
            secretPassword
        });

        console.log("âœ… GPT ì‘ë‹µ:", response.data);
        return response.data;
    } catch (error) {
        if (error.response) {
            if (error.response.status === 403) {
                alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.");
                return { error: "âŒ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜" };
            } else if (error.response.status === 500) {
                alert("âŒ ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                return { error: "âŒ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ" };
            }
        } else {
            alert("âŒ ìš”ì²­ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }

        console.error("âŒ API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        throw error;
    }
};
